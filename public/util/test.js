import QUnit from 'steal-qunit';
import { parseToRgb } from 'polished';
import lessFnResolver from './lessfn-resolver';

QUnit.module('lessFnResolver');

const getColorPerc = (v) => {
  const rgb = parseToRgb(v);
  if (!rgb.hasOwnProperty('alpha')) rgb.alpha = 1;
  return ((rgb.red + rgb.green + rgb.blue) / 255 + rgb.alpha) / 4;
};

// determines if two hex colors are very close to each other.
// This is needed to compare color values generated by "polished" to
// color values generated by a LESS compiler. The values should be very
// close, but not exact due to sligh differences in underlying algorithms.
const colorsAreClose = (c1, c2) => {
  // console.log('color diff', Math.abs(getColorPerc(c1) - getColorPerc(c2)));
  return Math.abs(getColorPerc(c1) - getColorPerc(c2)) < 0.03;
};

QUnit.test('works with known function names', () => {
  // The "expected" values came from a LESS compiler
  QUnit.ok(colorsAreClose(lessFnResolver('lighten(#345, 20%)'), '#597795'));
  QUnit.ok(colorsAreClose(lessFnResolver('darken(#345, 20%)'), '#0d1115'));
  QUnit.ok(colorsAreClose(lessFnResolver('tint(#345, 20%)'), '#5c6977'));
  QUnit.ok(colorsAreClose(lessFnResolver('shade(#345, 20%)'), '#293644'));
  QUnit.ok(colorsAreClose(lessFnResolver('saturate(#345, 20%)'), '#254463'));
  QUnit.ok(colorsAreClose(lessFnResolver('desaturate(#345, 20%)'), '#414447'));
  QUnit.ok(colorsAreClose(lessFnResolver('spin(#345, 187)'), '#554833'));
  QUnit.ok(colorsAreClose(lessFnResolver('mix(#345, #987, 40%)'), '#706d69'));
  QUnit.ok(colorsAreClose(lessFnResolver('mix(hsl(120,100%, 50%), hsla(200,100%, 50%, .5), 40%)'), 'rgba(0,227,85,0.7)'));
  QUnit.equal(lessFnResolver('fadeout(#fff, 20%)'), 'rgba(255,255,255,0.8)');
  QUnit.equal(lessFnResolver('fadein(rgba(0,0,0,0), 20%)'), 'rgba(0,0,0,0.2)');
  QUnit.equal(lessFnResolver('fade(rgba(12,34,56,0), 40%)'), 'rgba(12,34,56,0.4)');
});
